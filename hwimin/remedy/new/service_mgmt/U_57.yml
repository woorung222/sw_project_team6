---
- name: "U-57 | Remediate FTP Root Login Restriction (Controlled Env, Logs+JSON to /tmp, Stream-Split)"
  hosts: all
  become: yes
  gather_facts: no

  vars:
    FLAG_ID: "U-57"

    ftpusers_candidates:
      - "/etc/ftpusers"
      - "/etc/ftpd/ftpusers"

    vsftpd_conf_candidates:
      - "/etc/vsftpd/vsftpd.conf"
    vsftpd_ftpusers_candidates:
      - "/etc/vsftpd/ftpusers"
    vsftpd_user_list_candidates:
      - "/etc/vsftpd/user_list"

    proftpd_conf_candidates:
      - "/etc/proftpd/proftpd.conf"
      - "/etc/proftpd.conf"

    AUTO_OWNER: "root"
    AUTO_GROUP: "root"
    AUTO_MODE: "0640"

    deny_user: "root"

    LOG_SECTION_STEP: "[조치 내용]"

    TS_STDERR_CMD: "date -u +%Y-%m-%dT%H:%M:%SZ"
    TS_STDOUT_CMD: "date +%Y_%m_%d' / '%H:%M:%S"

    log_dir: "{{ isms_remediate_log_dir | default('/tmp') }}"
    json_dir: "{{ isms_remediate_json_dir | default('/tmp') }}"

    FILE_HOST: "{{ inventory_hostname | regex_replace('(-scan)$', '') }}"
    my_log_file: "{{ log_dir }}/{{ FILE_HOST }}-remediate_{{ FLAG_ID }}.log"
    my_json_file: "{{ json_dir }}/{{ FILE_HOST }}-remediate_{{ FLAG_ID }}.json"

  tasks:
    - name: "U-57 | init defaults"
      ansible.builtin.set_fact:
        ftpusers_path: ""
        vsftpd_conf_path: ""
        vsftpd_ftpusers_path: ""
        vsftpd_user_list_path: ""
        proftpd_conf_path: ""

        vsftpd_userlist_enable: ""
        vsftpd_userlist_deny: ""

        r_u571_line: {}
        r_u571_perm: {}

        r_u572_line: {}
        r_u572_perm: {}

        r_u573_line: {}
        r_u573_perm: {}

        r_u574_rootlogin: {}
        r_u574_restart: {}

        # 결과 계산용(문법 안정)
        u571_status: 0
        u571_desc: ""
        u571_result: ""
        u571_cmd: ""

        u572_status: 0
        u572_desc: ""
        u572_result: ""
        u572_cmd: ""

        u573_status: 0
        u573_desc: ""
        u573_result: ""
        u573_cmd: ""

        u574_status: 0
        u574_desc: ""
        u574_result: ""
        u574_cmd: ""
      changed_when: false

    # meta
    - name: "U-57 | meta | hostname"
      ansible.builtin.command: "hostname"
      register: m_host
      changed_when: false

    - name: "U-57 | meta | ip"
      ansible.builtin.shell: "hostname -I | awk '{print $1}'"
      register: m_ip
      changed_when: false

    - name: "U-57 | meta | user"
      ansible.builtin.command: "whoami"
      register: m_user
      changed_when: false

    - name: "U-57 | meta | set_fact"
      ansible.builtin.set_fact:
        META_HOSTNAME: "{{ m_host.stdout | default('') }}"
        META_IP: "{{ m_ip.stdout | default('') }}"
        META_USER: "{{ m_user.stdout | default('') }}"
      changed_when: false

    # path select
    - name: "U-57 | select ftpusers path"
      ansible.builtin.shell: |
        for p in {{ ftpusers_candidates | join(' ') }}; do
          [ -f "$p" ] && echo "$p" && exit 0
        done
        exit 1
      register: r_sel_ftpusers
      changed_when: false
      failed_when: false

    - name: "U-57 | select vsftpd conf path"
      ansible.builtin.shell: |
        for p in {{ vsftpd_conf_candidates | join(' ') }}; do
          [ -f "$p" ] && echo "$p" && exit 0
        done
        exit 1
      register: r_sel_vsconf
      changed_when: false
      failed_when: false

    - name: "U-57 | select vsftpd ftpusers path"
      ansible.builtin.shell: |
        for p in {{ vsftpd_ftpusers_candidates | join(' ') }}; do
          [ -f "$p" ] && echo "$p" && exit 0
        done
        exit 1
      register: r_sel_vsftpusers
      changed_when: false
      failed_when: false

    - name: "U-57 | select vsftpd user_list path"
      ansible.builtin.shell: |
        for p in {{ vsftpd_user_list_candidates | join(' ') }}; do
          [ -f "$p" ] && echo "$p" && exit 0
        done
        exit 1
      register: r_sel_vsuserlist
      changed_when: false
      failed_when: false

    - name: "U-57 | select proftpd conf path"
      ansible.builtin.shell: |
        for p in {{ proftpd_conf_candidates | join(' ') }}; do
          [ -f "$p" ] && echo "$p" && exit 0
        done
        exit 1
      register: r_sel_proconf
      changed_when: false
      failed_when: false

    - name: "U-57 | set_fact paths"
      ansible.builtin.set_fact:
        ftpusers_path: "{{ r_sel_ftpusers.stdout | default('') }}"
        vsftpd_conf_path: "{{ r_sel_vsconf.stdout | default('') }}"
        vsftpd_ftpusers_path: "{{ r_sel_vsftpusers.stdout | default('') }}"
        vsftpd_user_list_path: "{{ r_sel_vsuserlist.stdout | default('') }}"
        proftpd_conf_path: "{{ r_sel_proconf.stdout | default('') }}"
      changed_when: false

    # vsftpd parse
    - name: "U-57 | parse vsftpd userlist_enable/userlist_deny"
      ansible.builtin.shell: |
        e="$(grep -E '^[[:space:]]*userlist_enable=' '{{ vsftpd_conf_path }}' 2>/dev/null | tail -n 1 | cut -d= -f2 | tr -d '[:space:]')"
        d="$(grep -E '^[[:space:]]*userlist_deny='   '{{ vsftpd_conf_path }}' 2>/dev/null | tail -n 1 | cut -d= -f2 | tr -d '[:space:]')"
        echo "${e:-}"
        echo "${d:-}"
      register: r_vs_parse
      changed_when: false
      failed_when: false
      when: (vsftpd_conf_path | length) > 0

    - name: "U-57 | set_fact vsftpd settings"
      ansible.builtin.set_fact:
        vsftpd_userlist_enable: "{{ (r_vs_parse.stdout_lines[0] | default('')) }}"
        vsftpd_userlist_deny: "{{ (r_vs_parse.stdout_lines[1] | default('')) }}"
      changed_when: false
      when: (vsftpd_conf_path | length) > 0

    # =========================================================
    # U_57_1
    # =========================================================
    - name: "U-57 | [U_57_1] basic ftpusers deny root + perms + logs/json"
      block:
        - name: "U_57_1 | ensure root present(not commented) in ftpusers"
          ansible.builtin.lineinfile:
            path: "{{ ftpusers_path }}"
            regexp: '^[[:space:]]*#*[[:space:]]*root[[:space:]]*$'
            line: "root"
            insertafter: EOF
            create: no
            backup: yes
          register: r_u571_line
          when: (ftpusers_path | length) > 0
          failed_when: false

        - name: "U_57_1 | enforce perms on ftpusers"
          ansible.builtin.file:
            path: "{{ ftpusers_path }}"
            owner: "{{ AUTO_OWNER }}"
            group: "{{ AUTO_GROUP }}"
            mode: "{{ AUTO_MODE }}"
          register: r_u571_perm
          when: (ftpusers_path | length) > 0
          failed_when: false

        - name: "U_57_1 | compute | init"
          ansible.builtin.set_fact:
            u571_cmd: "edit {{ ftpusers_path | default('<none>') }} : ensure line=root; chown root:root; chmod 640"
            u571_status: 0
            u571_desc: ""
          changed_when: false

        - name: "U_57_1 | compute | ftpusers missing"
          ansible.builtin.set_fact:
            u571_status: 0
            u571_desc: "ftpusers 파일이 없어 조치하지 않았습니다"
          changed_when: false
          when: (ftpusers_path | length) == 0

        - name: "U_57_1 | compute | apply success"
          ansible.builtin.set_fact:
            u571_status: 2
            u571_desc: "ftpusers에 root 차단을 적용하고 권한(root:root, 640)을 설정했습니다"
          changed_when: false
          when:
            - (ftpusers_path | length) > 0
            - not ((r_u571_line.failed | default(false)) | bool)
            - not ((r_u571_perm.failed | default(false)) | bool)

        - name: "U_57_1 | compute | apply failed"
          ansible.builtin.set_fact:
            u571_status: 0
            u571_desc: "ftpusers 수정/권한 변경 실패로 조치하지 못했습니다"
          changed_when: false
          when:
            - (ftpusers_path | length) > 0
            - ((r_u571_line.failed | default(false)) | bool) or ((r_u571_perm.failed | default(false)) | bool)

        - name: "U_57_1 | compute | finalize result"
          ansible.builtin.set_fact:
            u571_result: "{{ ((u571_status | int) == 2) | ternary('조치 성공 (status: 2)', '조치 불가 (status: 0)') }}"
          changed_when: false

        - name: "U_57_1 | emit stderr log JSON (UTF8-safe)"
          delegate_to: localhost
          become: false
          ansible.builtin.shell: |
            printf '%s\n' '{{ {
              "ts": (ts.stderr_ts | default("")),
              "flag_id": "U_57_1",
              "section": LOG_SECTION_STEP,
              "title": "[U_57_1] (기본 FTP) ftpusers에 root 차단 설정",
              "cmd": u571_cmd,
              "result": u571_result
            } | to_json }}' \
            | python3 -c 'import json,sys; print(json.dumps(json.load(sys.stdin), ensure_ascii=False))' \
            | tee -a '{{ my_log_file }}' 1>&2
          vars:
            ts:
              stderr_ts: "{{ lookup('pipe', TS_STDERR_CMD) }}"
          changed_when: false

        - name: "U_57_1 | emit stdout result JSON (UTF8-safe)"
          delegate_to: localhost
          become: false
          ansible.builtin.shell: |
            printf '%s\n' '{{ {
              "meta": {"hostname": META_HOSTNAME, "ip": META_IP, "user": META_USER},
              "result": {
                "flag_id": "U_57_1",
                "status": (u571_status | int),
                "description": u571_desc,
                "category": "service",
                "timestamp": (ts.stdout_ts | default(""))
              }
            } | to_json }}' \
            | python3 -c 'import json,sys; print(json.dumps(json.load(sys.stdin), ensure_ascii=False))' \
            | tee -a '{{ my_json_file }}'
          vars:
            ts:
              stdout_ts: "{{ lookup('pipe', TS_STDOUT_CMD) }}"
          changed_when: false
      when:
        - "'U_57_1' in (flag_list | default([]))"

    # =========================================================
    # U_57_2
    # =========================================================
    - name: "U-57 | [U_57_2] vsftpd ftpusers deny root (when userlist_enable=NO) + logs/json"
      block:
        - name: "U_57_2 | ensure root present in /etc/vsftpd/ftpusers"
          ansible.builtin.lineinfile:
            path: "{{ vsftpd_ftpusers_path }}"
            regexp: '^[[:space:]]*#*[[:space:]]*root[[:space:]]*$'
            line: "root"
            insertafter: EOF
            create: no
            backup: yes
          register: r_u572_line
          when:
            - (vsftpd_ftpusers_path | length) > 0
            - (vsftpd_userlist_enable | default('') | upper) == "NO"
          failed_when: false

        - name: "U_57_2 | enforce perms on /etc/vsftpd/ftpusers"
          ansible.builtin.file:
            path: "{{ vsftpd_ftpusers_path }}"
            owner: "{{ AUTO_OWNER }}"
            group: "{{ AUTO_GROUP }}"
            mode: "{{ AUTO_MODE }}"
          register: r_u572_perm
          when:
            - (vsftpd_ftpusers_path | length) > 0
            - (vsftpd_userlist_enable | default('') | upper) == "NO"
          failed_when: false

        - name: "U_57_2 | compute | init"
          ansible.builtin.set_fact:
            u572_cmd: >-
              check vsftpd.conf userlist_enable;
              (if enable=NO) edit {{ vsftpd_ftpusers_path | default("<none>") }} : ensure line=root; chown root:root; chmod 640
            u572_status: 0
            u572_desc: ""
          changed_when: false

        - name: "U_57_2 | compute | missing file"
          ansible.builtin.set_fact:
            u572_status: 0
            u572_desc: "/etc/vsftpd/ftpusers 파일이 없어 조치하지 않았습니다"
          changed_when: false
          when:
            - (vsftpd_ftpusers_path | default('') | length) == 0

        - name: "U_57_2 | compute | skip (precondition not met)"
          ansible.builtin.set_fact:
            u572_status: 2
            u572_desc: "userlist_enable=NO 전제가 아니라 ftpusers 방식 조치를 스킵했습니다(현재={{ vsftpd_userlist_enable | default('<unset>') }})"
          changed_when: false
          when:
            - (vsftpd_ftpusers_path | default('') | length) > 0
            - (vsftpd_userlist_enable | default('') | upper) != "NO"

        - name: "U_57_2 | compute | apply success"
          ansible.builtin.set_fact:
            u572_status: 2
            u572_desc: "vsftpd ftpusers({{ vsftpd_ftpusers_path }})에 root 차단을 적용하고 권한(root:root, 640)을 설정했습니다"
          changed_when: false
          when:
            - (vsftpd_ftpusers_path | default('') | length) > 0
            - (vsftpd_userlist_enable | default('') | upper) == "NO"
            - not ((r_u572_line.failed | default(false)) | bool)
            - not ((r_u572_perm.failed | default(false)) | bool)

        - name: "U_57_2 | compute | apply failed"
          ansible.builtin.set_fact:
            u572_status: 0
            u572_desc: "vsftpd ftpusers 수정/권한 변경 실패로 조치하지 못했습니다"
          changed_when: false
          when:
            - (vsftpd_ftpusers_path | default('') | length) > 0
            - (vsftpd_userlist_enable | default('') | upper) == "NO"
            - ((r_u572_line.failed | default(false)) | bool) or ((r_u572_perm.failed | default(false)) | bool)

        - name: "U_57_2 | compute | finalize result"
          ansible.builtin.set_fact:
            u572_result: "{{ ((u572_status | int) == 2) | ternary('조치 성공 (status: 2)', '조치 불가 (status: 0)') }}"
          changed_when: false

        - name: "U_57_2 | emit stderr log JSON (UTF8-safe)"
          delegate_to: localhost
          become: false
          ansible.builtin.shell: |
            printf '%s\n' '{{ {
              "ts": (ts.stderr_ts | default("")),
              "flag_id": "U_57_2",
              "section": LOG_SECTION_STEP,
              "title": "[U_57_2] (vsftpd) ftpusers에 root 차단 설정(userlist_enable=NO 전제)",
              "cmd": u572_cmd,
              "result": u572_result
            } | to_json }}' \
            | python3 -c 'import json,sys; print(json.dumps(json.load(sys.stdin), ensure_ascii=False))' \
            | tee -a '{{ my_log_file }}' 1>&2
          vars:
            ts:
              stderr_ts: "{{ lookup('pipe', TS_STDERR_CMD) }}"
          changed_when: false

        - name: "U_57_2 | emit stdout result JSON (UTF8-safe)"
          delegate_to: localhost
          become: false
          ansible.builtin.shell: |
            printf '%s\n' '{{ {
              "meta": {"hostname": META_HOSTNAME, "ip": META_IP, "user": META_USER},
              "result": {
                "flag_id": "U_57_2",
                "status": (u572_status | int),
                "description": u572_desc,
                "category": "service",
                "timestamp": (ts.stdout_ts | default(""))
              }
            } | to_json }}' \
            | python3 -c 'import json,sys; print(json.dumps(json.load(sys.stdin), ensure_ascii=False))' \
            | tee -a '{{ my_json_file }}'
          vars:
            ts:
              stdout_ts: "{{ lookup('pipe', TS_STDOUT_CMD) }}"
          changed_when: false
      when:
        - "'U_57_2' in (flag_list | default([]))"

    # =========================================================
    # U_57_3
    # =========================================================
    - name: "U-57 | [U_57_3] vsftpd user_list deny root (when enable=YES & deny=YES) + logs/json"
      block:
        - name: "U_57_3 | ensure root present in user_list"
          ansible.builtin.lineinfile:
            path: "{{ vsftpd_user_list_path }}"
            regexp: '^[[:space:]]*#*[[:space:]]*root[[:space:]]*$'
            line: "root"
            insertafter: EOF
            create: no
            backup: yes
          register: r_u573_line
          when:
            - (vsftpd_user_list_path | length) > 0
            - (vsftpd_userlist_enable | default('') | upper) == "YES"
            - (vsftpd_userlist_deny | default('') | upper) == "YES"
          failed_when: false

        - name: "U_57_3 | enforce perms on user_list"
          ansible.builtin.file:
            path: "{{ vsftpd_user_list_path }}"
            owner: "{{ AUTO_OWNER }}"
            group: "{{ AUTO_GROUP }}"
            mode: "{{ AUTO_MODE }}"
          register: r_u573_perm
          when:
            - (vsftpd_user_list_path | length) > 0
            - (vsftpd_userlist_enable | default('') | upper) == "YES"
            - (vsftpd_userlist_deny | default('') | upper) == "YES"
          failed_when: false

        - name: "U_57_3 | compute | init"
          ansible.builtin.set_fact:
            u573_cmd: >-
              check vsftpd.conf userlist_enable/userlist_deny;
              (if enable=YES & deny=YES) edit {{ vsftpd_user_list_path | default("<none>") }} : ensure line=root; chown root:root; chmod 640
            u573_status: 0
            u573_desc: ""
          changed_when: false

        - name: "U_57_3 | compute | missing file"
          ansible.builtin.set_fact:
            u573_status: 0
            u573_desc: "/etc/vsftpd/user_list 파일이 없어 조치하지 않았습니다"
          changed_when: false
          when:
            - (vsftpd_user_list_path | default('') | length) == 0

        - name: "U_57_3 | compute | skip (precondition not met)"
          ansible.builtin.set_fact:
            u573_status: 2
            u573_desc: >-
              enable=YES & deny=YES 전제가 아니라 user_list 방식 조치를 스킵했습니다
              (enable={{ vsftpd_userlist_enable | default('<unset>') }},
               deny={{ vsftpd_userlist_deny | default('<unset>') }})
          changed_when: false
          when:
            - (vsftpd_user_list_path | default('') | length) > 0
            - (vsftpd_userlist_enable | default('') | upper) != "YES"
              or (vsftpd_userlist_deny | default('') | upper) != "YES"

        - name: "U_57_3 | compute | apply success"
          ansible.builtin.set_fact:
            u573_status: 2
            u573_desc: "user_list({{ vsftpd_user_list_path }})에 root 차단을 적용하고 권한(root:root, 640)을 설정했습니다"
          changed_when: false
          when:
            - (vsftpd_user_list_path | default('') | length) > 0
            - (vsftpd_userlist_enable | default('') | upper) == "YES"
            - (vsftpd_userlist_deny | default('') | upper) == "YES"
            - not ((r_u573_line.failed | default(false)) | bool)
            - not ((r_u573_perm.failed | default(false)) | bool)

        - name: "U_57_3 | compute | apply failed"
          ansible.builtin.set_fact:
            u573_status: 0
            u573_desc: "user_list 수정/권한 변경 실패로 조치하지 못했습니다"
          changed_when: false
          when:
            - (vsftpd_user_list_path | default('') | length) > 0
            - (vsftpd_userlist_enable | default('') | upper) == "YES"
            - (vsftpd_userlist_deny | default('') | upper) == "YES"
            - ((r_u573_line.failed | default(false)) | bool) or ((r_u573_perm.failed | default(false)) | bool)

        - name: "U_57_3 | compute | finalize result"
          ansible.builtin.set_fact:
            u573_result: "{{ ((u573_status | int) == 2) | ternary('조치 성공 (status: 2)', '조치 불가 (status: 0)') }}"
          changed_when: false

        - name: "U_57_3 | emit stderr log JSON (UTF8-safe)"
          delegate_to: localhost
          become: false
          ansible.builtin.shell: |
            printf '%s\n' '{{ {
              "ts": (ts.stderr_ts | default("")),
              "flag_id": "U_57_3",
              "section": LOG_SECTION_STEP,
              "title": "[U_57_3] (vsftpd) user_list에 root 차단 설정(enable=YES & deny=YES 전제)",
              "cmd": u573_cmd,
              "result": u573_result
            } | to_json }}' \
            | python3 -c 'import json,sys; print(json.dumps(json.load(sys.stdin), ensure_ascii=False))' \
            | tee -a '{{ my_log_file }}' 1>&2
          vars:
            ts:
              stderr_ts: "{{ lookup('pipe', TS_STDERR_CMD) }}"
          changed_when: false

        - name: "U_57_3 | emit stdout result JSON (UTF8-safe)"
          delegate_to: localhost
          become: false
          ansible.builtin.shell: |
            printf '%s\n' '{{ {
              "meta": {"hostname": META_HOSTNAME, "ip": META_IP, "user": META_USER},
              "result": {
                "flag_id": "U_57_3",
                "status": (u573_status | int),
                "description": u573_desc,
                "category": "service",
                "timestamp": (ts.stdout_ts | default(""))
              }
            } | to_json }}' \
            | python3 -c 'import json,sys; print(json.dumps(json.load(sys.stdin), ensure_ascii=False))' \
            | tee -a '{{ my_json_file }}'
          vars:
            ts:
              stdout_ts: "{{ lookup('pipe', TS_STDOUT_CMD) }}"
          changed_when: false
      when:
        - "'U_57_3' in (flag_list | default([]))"

    # =========================================================
    # U_57_4
    # =========================================================
    - name: "U-57 | [U_57_4] ProFTPD RootLogin off + restart (when changed) + logs/json"
      block:
        - name: "U_57_4 | ensure RootLogin off"
          ansible.builtin.lineinfile:
            path: "{{ proftpd_conf_path }}"
            regexp: '^[[:space:]]*RootLogin[[:space:]]+'
            line: "RootLogin off"
            create: no
            backup: yes
          register: r_u574_rootlogin
          when: (proftpd_conf_path | length) > 0
          failed_when: false

        - name: "U_57_4 | restart proftpd (only when changed)"
          ansible.builtin.systemd:
            name: "proftpd"
            state: restarted
          register: r_u574_restart
          failed_when: false
          when:
            - (proftpd_conf_path | length) > 0
            - ((r_u574_rootlogin.changed | default(false)) | bool)

        - name: "U_57_4 | compute | init"
          ansible.builtin.set_fact:
            u574_cmd: "proftpd.conf: RootLogin off; (if changed) systemctl restart proftpd"
            u574_status: 0
            u574_desc: ""
          changed_when: false

        - name: "U_57_4 | compute | missing proftpd.conf"
          ansible.builtin.set_fact:
            u574_status: 0
            u574_desc: "proftpd.conf가 없어 조치하지 않았습니다"
          changed_when: false
          when:
            - (proftpd_conf_path | default('') | length) == 0

        - name: "U_57_4 | compute | apply failed"
          ansible.builtin.set_fact:
            u574_status: 0
            u574_desc: "RootLogin 설정 반영에 실패했습니다"
          changed_when: false
          when:
            - (proftpd_conf_path | default('') | length) > 0
            - (r_u574_rootlogin.failed | default(false)) | bool

        - name: "U_57_4 | compute | apply success"
          ansible.builtin.set_fact:
            u574_status: 2
            u574_desc: >-
              ProFTPD RootLogin을 off로 정합했습니다
              (변경 시 재시작 포함)
          changed_when: false
          when:
            - (proftpd_conf_path | default('') | length) > 0
            - not ((r_u574_rootlogin.failed | default(false)) | bool)

        - name: "U_57_4 | compute | finalize result"
          ansible.builtin.set_fact:
            u574_result: "{{ ((u574_status | int) == 2) | ternary('조치 성공 (status: 2)', '조치 불가 (status: 0)') }}"
          changed_when: false

        - name: "U_57_4 | emit stderr log JSON (UTF8-safe)"
          delegate_to: localhost
          become: false
          ansible.builtin.shell: |
            printf '%s\n' '{{ {
              "ts": (ts.stderr_ts | default("")),
              "flag_id": "U_57_4",
              "section": LOG_SECTION_STEP,
              "title": "[U_57_4] ProFTPD RootLogin off 설정 및 서비스 재시작(변경 시)",
              "cmd": u574_cmd,
              "result": u574_result
            } | to_json }}' \
            | python3 -c 'import json,sys; print(json.dumps(json.load(sys.stdin), ensure_ascii=False))' \
            | tee -a '{{ my_log_file }}' 1>&2
          vars:
            ts:
              stderr_ts: "{{ lookup('pipe', TS_STDERR_CMD) }}"
          changed_when: false

        - name: "U_57_4 | emit stdout result JSON (UTF8-safe)"
          delegate_to: localhost
          become: false
          ansible.builtin.shell: |
            printf '%s\n' '{{ {
              "meta": {"hostname": META_HOSTNAME, "ip": META_IP, "user": META_USER},
              "result": {
                "flag_id": "U_57_4",
                "status": (u574_status | int),
                "description": u574_desc,
                "category": "service",
                "timestamp": (ts.stdout_ts | default(""))
              }
            } | to_json }}' \
            | python3 -c 'import json,sys; print(json.dumps(json.load(sys.stdin), ensure_ascii=False))' \
            | tee -a '{{ my_json_file }}'
          vars:
            ts:
              stdout_ts: "{{ lookup('pipe', TS_STDOUT_CMD) }}"
          changed_when: false
      when:
        - "'U_57_4' in (flag_list | default([]))"
