- name: "U_56 | Remediate FTP Access Control (Controlled Env, Logs+JSON to /tmp, Stream-Split, UTF8-safe, Host-Split)"
  hosts: all
  become: yes
  gather_facts: no

  vars:
    FLAG_ID: "U_56"

    # ==============================
    # FTP 접근제어(파일/설정) 후보 경로
    # ==============================
    ftpusers_candidates:
      - "/etc/ftpusers"
      - "/etc/ftpd/ftpusers"

    vsftpd_conf_candidates:
      - "/etc/vsftpd/vsftpd.conf"
      - "/etc/vsftpd.conf"
    vsftpd_ftpusers_candidates:
      - "/etc/vsftpd/ftpusers"
      - "/etc/vsftpd.ftpusers"
    vsftpd_user_list_candidates:
      - "/etc/vsftpd/user_list"
      - "/etc/vsftpd.user_list"

    proftpd_conf_candidates:
      - "/etc/proftpd/proftpd.conf"
      - "/etc/proftpd.conf"

    # ==============================
    # 안전 조치 기본값 (팀/통제환경 전제)
    # ==============================
    AUTO_OWNER: "root"
    AUTO_GROUP: "root"
    AUTO_MODE: "0640"

    # ==============================
    # (선택) ProFTPD allow/deny 정책 (비워두면 템플릿 미적용 + 수동반영 안내)
    # ==============================
    allow_from_ips: []
    allow_users: []
    deny_from_ips: []
    deny_users: []

    # ===== timestamp formats =====
    TS_STDERR_CMD: "date -u +%Y-%m-%dT%H:%M:%SZ"
    TS_STDOUT_CMD: "date +%Y_%m_%d' / '%H:%M:%S"

    # ==============================
    # [팀 조건] 로그/JSON 경로 및 파일명 규칙 (호스트별 분리 + scan 제거)
    # ==============================
    log_dir: "{{ isms_remediate_log_dir | default('/tmp') }}"
    json_dir: "{{ isms_remediate_json_dir | default('/tmp') }}"

    FILE_HOST: "{{ inventory_hostname | regex_replace('(-scan)$', '') }}"
    my_log_file: "{{ log_dir }}/{{ FILE_HOST }}-remediate_{{ FLAG_ID }}.log"
    my_json_file: "{{ json_dir }}/{{ FILE_HOST }}-remediate_{{ FLAG_ID }}.json"

  tasks:
    # ---------------------------------------------------------
    # (공통) 미정의 방지 (status/desc/result/cmd 포함)
    # ---------------------------------------------------------
    - name: "U_56 | init defaults"
      ansible.builtin.set_fact:
        ftpusers_path: ""
        vsftpd_conf_path: ""
        vsftpd_ftpusers_path: ""
        vsftpd_user_list_path: ""
        proftpd_conf_path: ""

        r_u561_perm: {}
        r_u562_perm: {}
        r_u563_conf_1: {}
        r_u563_conf_2: {}
        r_u563_conf_3: {}
        r_u563_list_perm: {}
        r_u563_restart: {}
        r_u565_conf_1: {}
        r_u565_conf_2: {}
        r_u565_restart: {}
        r_u564_useftp: {}
        r_u564_perm: {}
        U564_USEFTP: "ON"

        # ✅ 추가 반영(요청사항)
        u563_conf_changed: false
        u565_conf_changed: false
        u565_policy_provided: false

        u561_status: 0
        u561_desc: ""
        u561_result: ""
        u561_cmd: ""

        u562_status: 0
        u562_desc: ""
        u562_result: ""
        u562_cmd: ""

        u563_status: 0
        u563_desc: ""
        u563_result: ""
        u563_cmd: ""

        u564_status: 0
        u564_desc: ""
        u564_result: ""
        u564_cmd: ""

        u565_status: 0
        u565_desc: ""
        u565_result: ""
        u565_cmd: ""
      changed_when: false

    # ---------------------------------------------------------
    # (공통) meta 수집 (stdout JSON meta용)
    # ---------------------------------------------------------
    - name: "U_56 | meta | hostname"
      ansible.builtin.command: "hostname"
      register: m_host
      changed_when: false

    - name: "U_56 | meta | ip"
      ansible.builtin.shell: "hostname -I | awk '{print $1}'"
      register: m_ip
      changed_when: false

    - name: "U_56 | meta | user"
      ansible.builtin.command: "whoami"
      register: m_user
      changed_when: false

    - name: "U_56 | meta | set_fact"
      ansible.builtin.set_fact:
        META_HOSTNAME: "{{ m_host.stdout | default('') }}"
        META_IP: "{{ m_ip.stdout | default('') }}"
        META_USER: "{{ m_user.stdout | default('') }}"
      changed_when: false

    # ---------------------------------------------------------
    # (공통) 경로 탐색(존재하는 첫 번째 경로를 선택)
    # ---------------------------------------------------------
    - name: "U_56 | select ftpusers path"
      ansible.builtin.shell: |
        for p in {{ ftpusers_candidates | join(' ') }}; do
          [ -f "$p" ] && echo "$p" && exit 0
        done
        exit 1
      register: r_ftpusers
      changed_when: false
      failed_when: false

    - name: "U_56 | set_fact ftpusers_path"
      ansible.builtin.set_fact:
        ftpusers_path: "{{ r_ftpusers.stdout | default('') }}"
      changed_when: false

    - name: "U_56 | select vsftpd conf path"
      ansible.builtin.shell: |
        for p in {{ vsftpd_conf_candidates | join(' ') }}; do
          [ -f "$p" ] && echo "$p" && exit 0
        done
        exit 1
      register: r_vsftpd_conf
      changed_when: false
      failed_when: false

    - name: "U_56 | select vsftpd ftpusers path"
      ansible.builtin.shell: |
        for p in {{ vsftpd_ftpusers_candidates | join(' ') }}; do
          [ -f "$p" ] && echo "$p" && exit 0
        done
        exit 1
      register: r_vsftpd_ftpusers
      changed_when: false
      failed_when: false

    - name: "U_56 | select vsftpd user_list path"
      ansible.builtin.shell: |
        for p in {{ vsftpd_user_list_candidates | join(' ') }}; do
          [ -f "$p" ] && echo "$p" && exit 0
        done
        exit 1
      register: r_vsftpd_user_list
      changed_when: false
      failed_when: false

    - name: "U_56 | set_fact vsftpd paths"
      ansible.builtin.set_fact:
        vsftpd_conf_path: "{{ r_vsftpd_conf.stdout | default('') }}"
        vsftpd_ftpusers_path: "{{ r_vsftpd_ftpusers.stdout | default('') }}"
        vsftpd_user_list_path: "{{ r_vsftpd_user_list.stdout | default('') }}"
      changed_when: false

    - name: "U_56 | select proftpd conf path"
      ansible.builtin.shell: |
        for p in {{ proftpd_conf_candidates | join(' ') }}; do
          [ -f "$p" ] && echo "$p" && exit 0
        done
        exit 1
      register: r_proftpd_conf
      changed_when: false
      failed_when: false

    - name: "U_56 | set_fact proftpd_conf_path"
      ansible.builtin.set_fact:
        proftpd_conf_path: "{{ r_proftpd_conf.stdout | default('') }}"
      changed_when: false

    # =========================================================
    # U_56_1) ftpusers 파일 소유자/권한(root:root, 0640) 정합
    # =========================================================
    - name: "U_56 | [U_56_1] ftpusers file perms hardening"
      block:
        - name: "U_56_1 | enforce owner/group/mode on ftpusers_path (if exists)"
          ansible.builtin.file:
            path: "{{ ftpusers_path }}"
            owner: "{{ AUTO_OWNER }}"
            group: "{{ AUTO_GROUP }}"
            mode: "{{ AUTO_MODE }}"
          register: r_u561_perm
          when: ftpusers_path | length > 0
          failed_when: false

        - name: "U_56_1 | compute status/description/cmd"
          ansible.builtin.set_fact:
            u561_cmd: "chown {{ AUTO_OWNER }}:{{ AUTO_GROUP }} {{ ftpusers_path | default('<ftpusers>') }}; chmod {{ AUTO_MODE }} {{ ftpusers_path | default('<ftpusers>') }}"
            u561_status: >-
              {% if ftpusers_path | length == 0 %}
              0
              {% elif ((r_u561_perm.failed | default(false)) | bool) %}
              0
              {% else %}
              2
              {% endif %}
            u561_desc: >-
              {% if ftpusers_path | length == 0 %}
              ftpusers 파일이 존재하지 않아 조치하지 않았습니다
              {% elif ((r_u561_perm.failed | default(false)) | bool) %}
              ftpusers 파일 권한/소유자 변경에 실패했습니다
              {% else %}
              ftpusers 파일({{ ftpusers_path }}) 소유자/권한을 {{ AUTO_OWNER }}:{{ AUTO_GROUP }}, {{ AUTO_MODE }}로 설정했습니다
              {% endif %}
          changed_when: false

        - name: "U_56_1 | compute result string"
          ansible.builtin.set_fact:
            u561_result: "{{ ((u561_status | int) == 2) | ternary('조치 성공 (status: 2)', '조치 불가 (status: 0)') }}"
          changed_when: false

        - name: "U_56_1 | emit stderr log JSON (controller + stderr stream, UTF8-safe)"
          delegate_to: localhost
          become: false
          ansible.builtin.shell: |
            printf '%s\n' '{{ {
              "ts": (ts_561_e.stderr_ts | default("")),
              "flag_id": "U_56_1",
              "section": "ftpusers 파일 소유자/권한(root:root, 0640) 정합 적용",
              "title": "[U_56_1] ftpusers 파일 소유자/권한(root:root, 0640) 설정",
              "cmd": u561_cmd,
              "result": u561_result
            } | to_json }}' \
            | python3 -c 'import json,sys; print(json.dumps(json.load(sys.stdin), ensure_ascii=False))' \
            | tee -a '{{ my_log_file }}' 1>&2
          vars:
            ts_561_e:
              stderr_ts: "{{ lookup('pipe', TS_STDERR_CMD) }}"
          changed_when: false

        - name: "U_56_1 | emit stdout result JSON (controller + stdout stream, UTF8-safe)"
          delegate_to: localhost
          become: false
          ansible.builtin.shell: |
            printf '%s\n' '{{ {
              "meta": {"hostname": META_HOSTNAME, "ip": META_IP, "user": META_USER},
              "result": {
                "flag_id": "U_56_1",
                "status": (u561_status | int),
                "description": u561_desc,
                "category": "service",
                "timestamp": (ts_561_o.stdout_ts | default(""))
              }
            } | to_json }}' \
            | python3 -c 'import json,sys; print(json.dumps(json.load(sys.stdin), ensure_ascii=False))' \
            | tee -a '{{ my_json_file }}'
          vars:
            ts_561_o:
              stdout_ts: "{{ lookup('pipe', TS_STDOUT_CMD) }}"
          changed_when: false
      when:
        - "'U_56_1' in (flag_list | default([]))"

    # =========================================================
    # U_56_2) vsftpd ftpusers 파일 소유자/권한(root:root, 0640) 정합
    # =========================================================
    - name: "U_56 | [U_56_2] vsftpd ftpusers file perms hardening"
      block:
        - name: "U_56_2 | enforce perms on vsftpd ftpusers (if exists)"
          ansible.builtin.file:
            path: "{{ vsftpd_ftpusers_path }}"
            owner: "{{ AUTO_OWNER }}"
            group: "{{ AUTO_GROUP }}"
            mode: "{{ AUTO_MODE }}"
          register: r_u562_perm
          when: vsftpd_ftpusers_path | length > 0
          failed_when: false

        - name: "U_56_2 | compute status/description/cmd"
          ansible.builtin.set_fact:
            u562_cmd: "chown {{ AUTO_OWNER }}:{{ AUTO_GROUP }} {{ vsftpd_ftpusers_path | default('/etc/vsftpd/ftpusers') }}; chmod {{ AUTO_MODE }} {{ vsftpd_ftpusers_path | default('/etc/vsftpd/ftpusers') }}"
            u562_status: >-
              {% if vsftpd_ftpusers_path | length == 0 %}
              0
              {% elif ((r_u562_perm.failed | default(false)) | bool) %}
              0
              {% else %}
              2
              {% endif %}
            u562_desc: >-
              {% if vsftpd_ftpusers_path | length == 0 %}
              /etc/vsftpd/ftpusers 파일이 존재하지 않아 조치하지 않았습니다
              {% elif ((r_u562_perm.failed | default(false)) | bool) %}
              vsftpd ftpusers 파일 권한/소유자 변경에 실패했습니다
              {% else %}
              vsftpd ftpusers({{ vsftpd_ftpusers_path }}) 소유자/권한을 {{ AUTO_OWNER }}:{{ AUTO_GROUP }}, {{ AUTO_MODE }}로 설정했습니다
              {% endif %}
          changed_when: false

        - name: "U_56_2 | compute result string"
          ansible.builtin.set_fact:
            u562_result: "{{ ((u562_status | int) == 2) | ternary('조치 성공 (status: 2)', '조치 불가 (status: 0)') }}"
          changed_when: false

        - name: "U_56_2 | emit stderr log JSON (controller + stderr stream, UTF8-safe)"
          delegate_to: localhost
          become: false
          ansible.builtin.shell: |
            printf '%s\n' '{{ {
              "ts": (ts_562_e.stderr_ts | default("")),
              "flag_id": "U_56_2",
              "section": "vsftpd ftpusers 파일 소유자/권한(root:root, 0640) 정합 적용",
              "title": "[U_56_2] vsftpd ftpusers 파일 소유자/권한(root:root, 0640) 설정",
              "cmd": u562_cmd,
              "result": u562_result
            } | to_json }}' \
            | python3 -c 'import json,sys; print(json.dumps(json.load(sys.stdin), ensure_ascii=False))' \
            | tee -a '{{ my_log_file }}' 1>&2
          vars:
            ts_562_e:
              stderr_ts: "{{ lookup('pipe', TS_STDERR_CMD) }}"
          changed_when: false

        - name: "U_56_2 | emit stdout result JSON (controller + stdout stream, UTF8-safe)"
          delegate_to: localhost
          become: false
          ansible.builtin.shell: |
            printf '%s\n' '{{ {
              "meta": {"hostname": META_HOSTNAME, "ip": META_IP, "user": META_USER},
              "result": {
                "flag_id": "U_56_2",
                "status": (u562_status | int),
                "description": u562_desc,
                "category": "service",
                "timestamp": (ts_562_o.stdout_ts | default(""))
              }
            } | to_json }}' \
            | python3 -c 'import json,sys; print(json.dumps(json.load(sys.stdin), ensure_ascii=False))' \
            | tee -a '{{ my_json_file }}'
          vars:
            ts_562_o:
              stdout_ts: "{{ lookup('pipe', TS_STDOUT_CMD) }}"
          changed_when: false
      when:
        - "'U_56_2' in (flag_list | default([]))"

    # =========================================================
    # U_56_3) vsftpd user_list 기반 접근제어(userlist_enable/userlist_deny/userlist_file)
    # =========================================================
    - name: "U_56 | [U_56_3] vsftpd user_list access control enforce"
      block:
        - name: "U_56_3 | ensure vsftpd.conf userlist_enable=YES"
          ansible.builtin.lineinfile:
            path: "{{ vsftpd_conf_path }}"
            regexp: '^[[:space:]]*userlist_enable='
            line: "userlist_enable=YES"
            create: no
            backup: yes
          register: r_u563_conf_1
          when: vsftpd_conf_path | length > 0
          failed_when: false

        - name: "U_56_3 | ensure vsftpd.conf userlist_deny=YES"
          ansible.builtin.lineinfile:
            path: "{{ vsftpd_conf_path }}"
            regexp: '^[[:space:]]*userlist_deny='
            line: "userlist_deny=YES"
            create: no
            backup: yes
          register: r_u563_conf_2
          when: vsftpd_conf_path | length > 0
          failed_when: false

        - name: "U_56_3 | ensure vsftpd.conf userlist_file=<user_list>"
          ansible.builtin.lineinfile:
            path: "{{ vsftpd_conf_path }}"
            regexp: '^[[:space:]]*userlist_file='
            line: "userlist_file={{ (vsftpd_user_list_path | length > 0) | ternary(vsftpd_user_list_path, '/etc/vsftpd/user_list') }}"
            create: no
            backup: yes
          register: r_u563_conf_3
          when: vsftpd_conf_path | length > 0
          failed_when: false

        - name: "U_56_3 | ensure user_list file perms (if exists)"
          ansible.builtin.file:
            path: "{{ vsftpd_user_list_path }}"
            owner: "{{ AUTO_OWNER }}"
            group: "{{ AUTO_GROUP }}"
            mode: "{{ AUTO_MODE }}"
          register: r_u563_list_perm
          when: vsftpd_user_list_path | length > 0
          failed_when: false

        - name: "U_56_3 | compute changed flag"
          ansible.builtin.set_fact:
            u563_conf_changed: >-
              {{
                ((r_u563_conf_1.changed | default(false)) or
                 (r_u563_conf_2.changed | default(false)) or
                 (r_u563_conf_3.changed | default(false))) | bool
              }}
          changed_when: false

        - name: "U_56_3 | restart vsftpd (only when conf changed)"
          ansible.builtin.systemd:
            name: "vsftpd"
            state: restarted
          register: r_u563_restart
          failed_when: false
          when:
            - (vsftpd_conf_path | length > 0)
            - (u563_conf_changed | bool)

        - name: "U_56_3 | compute status/description/cmd"
          ansible.builtin.set_fact:
            u563_cmd: "vsftpd.conf: userlist_enable=YES; userlist_deny=YES; userlist_file=/etc/vsftpd/user_list; (if changed) systemctl restart vsftpd"
            u563_status: >-
              {% if vsftpd_conf_path | length == 0 %}
              0
              {% else %}
              2
              {% endif %}
            u563_desc: >-
              {% if vsftpd_conf_path | length == 0 %}
              vsftpd.conf가 없어 조치하지 않았습니다
              {% elif (u563_conf_changed | bool) %}
              vsftpd 접근제어(user_list 기반) 설정을 적용했습니다. (userlist_enable=YES, userlist_deny=YES)
              {% else %}
              vsftpd 접근제어 설정이 이미 정합합니다
              {% endif %}
          changed_when: false

        - name: "U_56_3 | compute result string"
          ansible.builtin.set_fact:
            u563_result: "{{ ((u563_status | int) == 2) | ternary('조치 성공 (status: 2)', '조치 불가 (status: 0)') }}"
          changed_when: false

        - name: "U_56_3 | emit stderr log JSON (controller + stderr stream, UTF8-safe)"
          delegate_to: localhost
          become: false
          ansible.builtin.shell: |
            printf '%s\n' '{{ {
              "ts": (ts_563_e.stderr_ts | default("")),
              "flag_id": "U_56_3",
              "section": "vsftpd user_list 기반 접근제어(userlist_enable/userlist_deny/userlist_file) 설정",
              "title": "[U_56_3] vsftpd user_list 기반 접근제어 설정(userlist_enable/userlist_deny)",
              "cmd": u563_cmd,
              "result": u563_result
            } | to_json }}' \
            | python3 -c 'import json,sys; print(json.dumps(json.load(sys.stdin), ensure_ascii=False))' \
            | tee -a '{{ my_log_file }}' 1>&2
          vars:
            ts_563_e:
              stderr_ts: "{{ lookup('pipe', TS_STDERR_CMD) }}"
          changed_when: false

        - name: "U_56_3 | emit stdout result JSON (controller + stdout stream, UTF8-safe)"
          delegate_to: localhost
          become: false
          ansible.builtin.shell: |
            printf '%s\n' '{{ {
              "meta": {"hostname": META_HOSTNAME, "ip": META_IP, "user": META_USER},
              "result": {
                "flag_id": "U_56_3",
                "status": (u563_status | int),
                "description": u563_desc,
                "category": "service",
                "timestamp": (ts_563_o.stdout_ts | default(""))
              }
            } | to_json }}' \
            | python3 -c 'import json,sys; print(json.dumps(json.load(sys.stdin), ensure_ascii=False))' \
            | tee -a '{{ my_json_file }}'
          vars:
            ts_563_o:
              stdout_ts: "{{ lookup('pipe', TS_STDOUT_CMD) }}"
          changed_when: false
      when:
        - "'U_56_3' in (flag_list | default([]))"

    # =========================================================
    # U_56_4) ProFTPD - UseFtpUsers ON(OFF 아님)일 때 ftpusers 파일 권한/소유자 정합(root:root, 0640)
    # =========================================================
    - name: "U_56 | [U_56_4] proftpd ftpusers perms hardening (when UseFtpUsers ON)"
      block:
        - name: "U_56_4 | read UseFtpUsers value (ignore comments)"
          ansible.builtin.shell: |
            set -o pipefail
            grep -v '^[[:space:]]*#' "{{ proftpd_conf_path }}" 2>/dev/null \
              | grep -i '^[[:space:]]*UseFtpUsers[[:space:]]\+' \
              | awk '{print $2}' \
              | head -1 \
              | tr 'a-z' 'A-Z' \
              || true
          register: r_u564_useftp
          changed_when: false
          failed_when: false
          when: proftpd_conf_path | length > 0

        - name: "U_56_4 | set_fact UseFtpUsers (default ON when missing)"
          ansible.builtin.set_fact:
            U564_USEFTP: >-
              {{
                (proftpd_conf_path | length == 0)
                | ternary(
                    "",
                    (
                      (r_u564_useftp.stdout | default('') | trim | length > 0)
                      | ternary((r_u564_useftp.stdout | trim), 'ON')
                    )
                  )
              }}
          changed_when: false

        - name: "U_56_4 | enforce perms on ftpusers_path (only when UseFtpUsers != OFF)"
          ansible.builtin.file:
            path: "{{ ftpusers_path }}"
            owner: "{{ AUTO_OWNER }}"
            group: "{{ AUTO_GROUP }}"
            mode: "{{ AUTO_MODE }}"
          register: r_u564_perm
          when:
            - proftpd_conf_path | length > 0
            - (U564_USEFTP | default('ON')) != 'OFF'
            - ftpusers_path | length > 0
          failed_when: false

        - name: "U_56_4 | compute status/description/result/cmd (stable)"
          block:
            - name: "U_56_4 | compute | init"
              ansible.builtin.set_fact:
                u564_cmd: "proftpd.conf: UseFtpUsers 확인; (UseFtpUsers ON이면) chown {{ AUTO_OWNER }}:{{ AUTO_GROUP }} {{ ftpusers_path | default('<ftpusers>') }}; chmod {{ AUTO_MODE }} {{ ftpusers_path | default('<ftpusers>') }}"
                u564_status: 0
                u564_desc: ""
              changed_when: false

            - name: "U_56_4 | compute | proftpd conf missing"
              ansible.builtin.set_fact:
                u564_status: 0
                u564_desc: "proftpd.conf가 없어 조치할 수 없습니다"
              changed_when: false
              when:
                - proftpd_conf_path | length == 0

            - name: "U_56_4 | compute | UseFtpUsers OFF (N/A)"
              ansible.builtin.set_fact:
                u564_status: 2
                u564_desc: "UseFtpUsers=OFF 상태로 U_56_4(ftpusers 권한 정합) 해당 사항이 없습니다"
              changed_when: false
              when:
                - proftpd_conf_path | length > 0
                - (U564_USEFTP | default('ON')) == 'OFF'

            - name: "U_56_4 | compute | UseFtpUsers ON but ftpusers missing"
              ansible.builtin.set_fact:
                u564_status: 0
                u564_desc: "UseFtpUsers=ON 상태이나 ftpusers 파일(/etc/ftpusers 또는 /etc/ftpd/ftpusers)이 없어 조치할 수 없습니다"
              changed_when: false
              when:
                - proftpd_conf_path | length > 0
                - (U564_USEFTP | default('ON')) != 'OFF'
                - ftpusers_path | length == 0

            - name: "U_56_4 | compute | apply success"
              ansible.builtin.set_fact:
                u564_status: 2
                u564_desc: "ProFTPD UseFtpUsers=ON 조건에서 ftpusers 파일({{ ftpusers_path }}) 소유자/권한을 {{ AUTO_OWNER }}:{{ AUTO_GROUP }}, {{ AUTO_MODE }}로 설정했습니다"
              changed_when: false
              when:
                - proftpd_conf_path | length > 0
                - (U564_USEFTP | default('ON')) != 'OFF'
                - ftpusers_path | length > 0
                - not ((r_u564_perm.failed | default(false)) | bool)

            - name: "U_56_4 | compute | apply failed"
              ansible.builtin.set_fact:
                u564_status: 0
                u564_desc: "ftpusers 파일 권한/소유자 변경에 실패했습니다"
              changed_when: false
              when:
                - proftpd_conf_path | length > 0
                - (U564_USEFTP | default('ON')) != 'OFF'
                - ftpusers_path | length > 0
                - ((r_u564_perm.failed | default(false)) | bool)

            - name: "U_56_4 | compute | finalize result"
              ansible.builtin.set_fact:
                u564_result: "{{ ((u564_status | int) == 2) | ternary('조치 성공 (status: 2)', '조치 불가 (status: 0)') }}"
              changed_when: false

        - name: "U_56_4 | emit stderr log JSON (controller + stderr stream, UTF8-safe)"
          delegate_to: localhost
          become: false
          ansible.builtin.shell: |
            printf '%s\n' '{{ {
              "ts": (ts_564_e.stderr_ts | default("")),
              "flag_id": "U_56_4",
              "section": "ProFTPD UseFtpUsers=ON 조건에서 ftpusers 파일 소유자/권한(root:root, 0640) 정합 적용",
              "title": "[U_56_4] ProFTPD ftpusers 권한/소유자 정합(root:root, 0640)",
              "cmd": u564_cmd,
              "result": u564_result
            } | to_json }}' \
            | python3 -c 'import json,sys; print(json.dumps(json.load(sys.stdin), ensure_ascii=False))' \
            | tee -a '{{ my_log_file }}' 1>&2
          vars:
            ts_564_e:
              stderr_ts: "{{ lookup('pipe', TS_STDERR_CMD) }}"
          changed_when: false

        - name: "U_56_4 | emit stdout result JSON (controller + stdout stream, UTF8-safe)"
          delegate_to: localhost
          become: false
          ansible.builtin.shell: |
            printf '%s\n' '{{ {
              "meta": {"hostname": META_HOSTNAME, "ip": META_IP, "user": META_USER},
              "result": {
                "flag_id": "U_56_4",
                "status": (u564_status | int),
                "description": u564_desc,
                "category": "service",
                "timestamp": (ts_564_o.stdout_ts | default(""))
              }
            } | to_json }}' \
            | python3 -c 'import json,sys; print(json.dumps(json.load(sys.stdin), ensure_ascii=False))' \
            | tee -a '{{ my_json_file }}'
          vars:
            ts_564_o:
              stdout_ts: "{{ lookup('pipe', TS_STDOUT_CMD) }}"
          changed_when: false
      when:
        - "'U_56_4' in (flag_list | default([]))"

    # =========================================================
    # U_56_5) ProFTPD 접근제어: UseFtpUsers + (선택) <Limit LOGIN> allow/deny 템플릿
    # =========================================================
    - name: "U_56 | [U_56_5] proftpd access control (UseFtpUsers + optional <Limit LOGIN>)"
      block:
        - name: "U_56_5 | ensure UseFtpUsers on"
          ansible.builtin.lineinfile:
            path: "{{ proftpd_conf_path }}"
            regexp: '^[[:space:]]*UseFtpUsers[[:space:]]+'
            line: "UseFtpUsers on"
            create: no
            backup: yes
          register: r_u565_conf_1
          when: proftpd_conf_path | length > 0
          failed_when: false

        - name: "U_56_5 | optionally insert <Limit LOGIN> policy block (only if any allow/deny provided)"
          ansible.builtin.blockinfile:
            path: "{{ proftpd_conf_path }}"
            marker: "# {mark} ANSIBLE_U56_LIMIT_LOGIN"
            insertafter: EOF
            block: |
              <Limit LOGIN>
                Order Deny,Allow
              {% for u in allow_users %}
                AllowUser {{ u }}
              {% endfor %}
              {% for ip in allow_from_ips %}
                Allow from {{ ip }}
              {% endfor %}
              {% for u in deny_users %}
                DenyUser {{ u }}
              {% endfor %}
              {% for ip in deny_from_ips %}
                Deny from {{ ip }}
              {% endfor %}
              </Limit>
          register: r_u565_conf_2
          when:
            - proftpd_conf_path | length > 0
            - (allow_users | length > 0) or (allow_from_ips | length > 0) or (deny_users | length > 0) or (deny_from_ips | length > 0)
          failed_when: false

        - name: "U_56_5 | compute changed flag"
          ansible.builtin.set_fact:
            u565_conf_changed: >-
              {{
                ((r_u565_conf_1.changed | default(false)) or
                 (r_u565_conf_2.changed | default(false))) | bool
              }}
            u565_policy_provided: >-
              {{
                ((allow_users | length > 0) or (allow_from_ips | length > 0) or
                 (deny_users | length > 0) or (deny_from_ips | length > 0)) | bool
              }}
          changed_when: false

        - name: "U_56_5 | restart proftpd (only when changed)"
          ansible.builtin.systemd:
            name: "proftpd"
            state: restarted
          register: r_u565_restart
          failed_when: false
          when:
            - (proftpd_conf_path | length > 0)
            - (u565_conf_changed | bool)

        - name: "U_56_5 | compute status/description/cmd"
          ansible.builtin.set_fact:
            u565_cmd: "proftpd.conf: UseFtpUsers on; (optional) <Limit LOGIN> allow/deny; (if changed) systemctl restart proftpd"
            u565_status: >-
              {% if proftpd_conf_path | length == 0 %}
              0
              {% else %}
              2
              {% endif %}
            u565_desc: >-
              {% if proftpd_conf_path | length == 0 %}
              proftpd.conf가 없어 조치하지 않았습니다
              {% elif (u565_conf_changed | bool) %}
              ProFTPD 접근제어 설정을 적용했습니다(UseFtpUsers on 및 필요 시 <Limit LOGIN> 반영)
              {% else %}
              {% if (u565_policy_provided | bool) %}
              ProFTPD 접근제어 설정이 이미 정합합니다
              {% else %}
              UseFtpUsers 정합만 확인/적용했습니다. IP/사용자 allow/deny 정책은 입력값이 없어 수동 반영 대상입니다
              {% endif %}
              {% endif %}
          changed_when: false

        - name: "U_56_5 | compute result string"
          ansible.builtin.set_fact:
            u565_result: "{{ ((u565_status | int) == 2) | ternary('조치 성공 (status: 2)', '조치 불가 (status: 0)') }}"
          changed_when: false

        - name: "U_56_5 | emit stderr log JSON (controller + stderr stream, UTF8-safe)"
          delegate_to: localhost
          become: false
          ansible.builtin.shell: |
            printf '%s\n' '{{ {
              "ts": (ts_565_e.stderr_ts | default("")),
              "flag_id": "U_56_5",
              "section": "ProFTPD 접근제어 설정(UseFtpUsers on 및 선택 <Limit LOGIN> allow/deny 적용)",
              "title": "[U_56_5] ProFTPD 접근제어 설정(UseFtpUsers + <Limit LOGIN>)",
              "cmd": u565_cmd,
              "result": u565_result
            } | to_json }}' \
            | python3 -c 'import json,sys; print(json.dumps(json.load(sys.stdin), ensure_ascii=False))' \
            | tee -a '{{ my_log_file }}' 1>&2
          vars:
            ts_565_e:
              stderr_ts: "{{ lookup('pipe', TS_STDERR_CMD) }}"
          changed_when: false

        - name: "U_56_5 | emit stdout result JSON (controller + stdout stream, UTF8-safe)"
          delegate_to: localhost
          become: false
          ansible.builtin.shell: |
            printf '%s\n' '{{ {
              "meta": {"hostname": META_HOSTNAME, "ip": META_IP, "user": META_USER},
              "result": {
                "flag_id": "U_56_5",
                "status": (u565_status | int),
                "description": u565_desc,
                "category": "service",
                "timestamp": (ts_565_o.stdout_ts | default(""))
              }
            } | to_json }}' \
            | python3 -c 'import json,sys; print(json.dumps(json.load(sys.stdin), ensure_ascii=False))' \
            | tee -a '{{ my_json_file }}'
          vars:
            ts_565_o:
              stdout_ts: "{{ lookup('pipe', TS_STDOUT_CMD) }}"
          changed_when: false
      when:
        - "'U_56_5' in (flag_list | default([]))"
