    ---
    - name: "U-61 | Remediate SNMP Access Control (Controlled Env, Logs-Only JSONL)"
      hosts: all
      become: yes
      gather_facts: no
    
      vars:
        FLAG_ID: "U-61"
    
        # ===== 팀 로그 템플릿(고정) =====
        LOG_SECTION_STEP: "[조치 내용]"
        LOG_SECTION_BASIS: "[조치 결과]"
        LOG_TITLE_BASIS: "조치 근거"
        LOG_TS_CMD: "date +%Y-%m-%dT%H:%M:%S%z"
    
        # ===== 타겟 =====
        SNMPD_SERVICE: "snmpd"
        SNMPD_CONF: "/etc/snmp/snmpd.conf"
    
        # ===== 운영자 지정 값(필수: SNMP 사용 중이면 반드시 지정) =====
        # 예) "192.168.10.10" 또는 "192.168.10.0/24"
        # 비워두면(기본값) 자동조치 금지(info)로만 기록
        ALLOW_SNMP_SOURCE: ""
    
      tasks:
        # ---------------------------------------------------------
        # (공통) 미정의 방지
        # ---------------------------------------------------------
        - name: "U-61 | init defaults"
          ansible.builtin.set_fact:
            os_family: "UNKNOWN"          # REDHAT / DEBIAN / UNKNOWN
            snmpd_unit_exists: "NO"
            snmpd_is_active: "NO"
            snmpd_proc_exists: "NO"
            snmpd_conf_exists: false
    
            # 점검 결과
            weak_acl_found: "NO"          # default/0.0.0.0/0 등 "전체 허용" 탐지 여부
            fix_allowed: "NO"             # ALLOW_SNMP_SOURCE 유효성 충족 여부
    
            r_fix_acl: {}
            r_restart: {}
          changed_when: false
    
        # =========================================================
        # U_61_1 : OS 계열 확인(스크립트와 동일한 기준)
        # =========================================================
        - name: "U-61 | detect OS family"
          ansible.builtin.shell: |
            if [ -f /etc/redhat-release ]; then
              echo "REDHAT"
            elif [ -f /etc/debian_version ]; then
              echo "DEBIAN"
            else
              echo "UNKNOWN"
            fi
          args:
            executable: /bin/bash
          register: r_os
          changed_when: false
          failed_when: false
    
        - name: "U-61 | set os_family"
          ansible.builtin.set_fact:
            os_family: "{{ r_os.stdout | default('UNKNOWN') }}"
          changed_when: false
    
        # =========================================================
        # U_61_1 : snmpd 상태/설정파일 존재 확인
        # =========================================================
        - name: "U-61 | detect snmpd.service unit"
          ansible.builtin.shell: |
            systemctl list-unit-files --type=service 2>/dev/null | awk '{print $1}' | grep -qx "{{ SNMPD_SERVICE }}.service" && echo "YES" || echo "NO"
          args:
            executable: /bin/bash
          register: r_unit
          changed_when: false
          failed_when: false
    
        - name: "U-61 | set snmpd_unit_exists"
          ansible.builtin.set_fact:
            snmpd_unit_exists: "{{ (r_unit.stdout | default('NO')) }}"
          changed_when: false
    
        - name: "U-61 | check snmpd is-active (when unit exists)"
          ansible.builtin.shell: |
            systemctl is-active "{{ SNMPD_SERVICE }}" >/dev/null 2>&1 && echo "YES" || echo "NO"
          args:
            executable: /bin/bash
          register: r_active
          changed_when: false
          failed_when: false
          when: snmpd_unit_exists == "YES"
    
        - name: "U-61 | set snmpd_is_active"
          ansible.builtin.set_fact:
            snmpd_is_active: "{{ (r_active.stdout | default('NO')) }}"
          changed_when: false
          when: snmpd_unit_exists == "YES"
    
        - name: "U-61 | check snmpd process exists (fallback)"
          ansible.builtin.shell: |
            ps -ef 2>/dev/null | grep -v grep | grep -q "[s]nmpd" && echo "YES" || echo "NO"
          args:
            executable: /bin/bash
          register: r_proc
          changed_when: false
          failed_when: false
    
        - name: "U-61 | set snmpd_proc_exists"
          ansible.builtin.set_fact:
            snmpd_proc_exists: "{{ (r_proc.stdout | default('NO')) }}"
          changed_when: false
    
        - name: "U-61 | stat snmpd.conf"
          ansible.builtin.stat:
            path: "{{ SNMPD_CONF }}"
          register: st_conf
          changed_when: false
    
        - name: "U-61 | set snmpd_conf_exists"
          ansible.builtin.set_fact:
            snmpd_conf_exists: "{{ st_conf.stat.exists | default(false) }}"
          changed_when: false
    
        - name: "U-61 | ts (detect)"
          ansible.builtin.command: "{{ LOG_TS_CMD }}"
          register: ts_611_a
          changed_when: false
    
        - name: "U-61 | LOG step (detect) JSONL"
          ansible.builtin.debug:
            msg: >-
              {{
                {
                  "ts": (ts_611_a.stdout | default("")),
                  "flag_id": FLAG_ID,
                  "section": LOG_SECTION_STEP,
                  "title": "[U_61_1] SNMP 접근제어 대상 탐지(OS/서비스/설정파일)",
                  "cmd": "detect OS + unit + is-active + ps + stat snmpd.conf",
                  "result": "os=" ~ (os_family | default("UNKNOWN"))
                            ~ ", unit_exists=" ~ (snmpd_unit_exists | default("NO"))
                            ~ ", is_active=" ~ (snmpd_is_active | default("NO"))
                            ~ ", proc_exists=" ~ (snmpd_proc_exists | default("NO"))
                            ~ ", conf_exists=" ~ (((snmpd_conf_exists | default(false))|bool)|string)
                } | to_json
              }}
          changed_when: false
    
        # =========================================================
        # U_61_1 : 취약 ACL(전체 허용) 탐지
        # - DEBIAN: rocommunity/rwcommunity 3번째 필드가 없거나 default/0.0.0.0/0 등 → 취약
        # - REDHAT: com2sec의 source가 default/0.0.0.0(또는 0.0.0.0/0) → 취약
        # =========================================================
        - name: "U-61 | detect weak ACL in snmpd.conf (non-comment)"
          ansible.builtin.shell: |
            set -o pipefail
            CONF="{{ SNMPD_CONF }}"
            if [ ! -f "$CONF" ]; then
              echo "NO"; exit 0
            fi
    
            if [ "{{ os_family }}" = "DEBIAN" ]; then
              # rocommunity <string> <source>
              # rwcommunity <string> <source>
              # source가 없거나 default/0.0.0.0/0 이면 취약
              weak=0
              while read -r line; do
                [ -z "$line" ] && continue
                addr=$(echo "$line" | awk '{print $3}')
                if [ -z "$addr" ] || [ "$addr" = "default" ] || [ "$addr" = "0.0.0.0" ] || [ "$addr" = "0.0.0.0/0" ]; then
                  weak=1; break
                fi
              done < <(grep -v "^[[:space:]]*#" "$CONF" 2>/dev/null | grep -E "^[[:space:]]*(rocommunity|rwcommunity)[[:space:]]+")
              [ $weak -eq 1 ] && echo "YES" || echo "NO"
              exit 0
            fi
    
            if [ "{{ os_family }}" = "REDHAT" ]; then
              # com2sec <NAME> <SOURCE> <COMMUNITY>
              # SOURCE가 default/0.0.0.0/0 이면 취약
              if grep -v "^[[:space:]]*#" "$CONF" 2>/dev/null | grep -E "^[[:space:]]*com2sec[[:space:]]+" \
                | awk '$3=="default" || $3=="0.0.0.0" || $3=="0.0.0.0/0"' | grep -q .; then
                echo "YES"; exit 0
              fi
              echo "NO"; exit 0
            fi
    
            # OS UNKNOWN: 판단 불가 → 보수적으로 info로만 처리(여기서는 weak=NO로 두고 basis에서 info)
            echo "NO"
          args:
            executable: /bin/bash
          register: r_weak
          changed_when: false
          failed_when: false
    
        - name: "U-61 | set weak_acl_found"
          ansible.builtin.set_fact:
            weak_acl_found: "{{ (r_weak.stdout | default('NO')) }}"
          changed_when: false
    
        - name: "U-61 | validate ALLOW_SNMP_SOURCE (fix_allowed)"
          ansible.builtin.set_fact:
            fix_allowed: >-
              {{
                (
                  (ALLOW_SNMP_SOURCE | default('') | trim) != ''
                  and (ALLOW_SNMP_SOURCE | trim) not in ['default','0.0.0.0','0.0.0.0/0']
                )
                | ternary('YES','NO')
              }}
          changed_when: false
    
        - name: "U-61 | ts (weak check)"
          ansible.builtin.command: "{{ LOG_TS_CMD }}"
          register: ts_611_b
          changed_when: false
    
        - name: "U-61 | LOG step (weak ACL check) JSONL"
          ansible.builtin.debug:
            msg: >-
              {{
                {
                  "ts": (ts_611_b.stdout | default("")),
                  "flag_id": FLAG_ID,
                  "section": LOG_SECTION_STEP,
                  "title": "[U_61_1] SNMP 접근제어 설정 점검(전체허용 여부)",
                  "cmd": "parse non-comment lines: DEBIAN(rocommunity/rwcommunity) or REDHAT(com2sec)",
                  "result": "weak_acl_found=" ~ (weak_acl_found | default("NO"))
                            ~ ", allow_source_provided=" ~ (fix_allowed | default("NO"))
                            ~ ", allow_source=" ~ ((ALLOW_SNMP_SOURCE | default('') | trim) | default("<empty>"))
                } | to_json
              }}
          changed_when: false
    
        # =========================================================
        # U_61_1 : 조치(보수적)
        # - weak_acl_found=YES AND fix_allowed=YES AND conf_exists=YES 일 때만 자동조치
        # - DEBIAN: rocommunity/rwcommunity에 source가 없거나 default/0.0.0.0(/0)이면 source를 ALLOW_SNMP_SOURCE로 교정
        # - REDHAT: com2sec source가 default/0.0.0.0(/0)이면 source를 ALLOW_SNMP_SOURCE로 교정
        # - 변경 시 snmpd restart 시도(실패해도 fail 처리 안 함)
        # =========================================================
        - name: "U-61 | remediate ACL (DEBIAN)"
          ansible.builtin.shell: |
            set -o pipefail
            CONF="{{ SNMPD_CONF }}"
            SRC="{{ ALLOW_SNMP_SOURCE | trim }}"
            # rocommunity/rwcommunity:
            #  - source 누락: 끝에 " <SRC>" 추가
            #  - source=default/0.0.0.0(/0): 3번째 필드 치환
            tmp="$(mktemp)"
            awk -v SRC="$SRC" '
              BEGIN{OFS=" "}
              /^[[:space:]]*#/ {print; next}
              /^[[:space:]]*(rocommunity|rwcommunity)[[:space:]]+/ {
                # 필드 수 2면 source 없음 → 추가
                if (NF==2) {print $1,$2,SRC; next}
                # 필드 수>=3이면 source 검사
                if ($3=="default" || $3=="0.0.0.0" || $3=="0.0.0.0/0") {$3=SRC}
                print; next
              }
              {print}
            ' "$CONF" > "$tmp"
            if ! cmp -s "$CONF" "$tmp"; then
              cp -p "$CONF" "$CONF.bak.U61.$(date +%Y%m%d%H%M%S)"
              cat "$tmp" > "$CONF"
              echo "CHANGED"
            else
              echo "NOCHANGE"
            fi
            rm -f "$tmp"
          args:
            executable: /bin/bash
          register: r_fix_acl_debian
          changed_when: (r_fix_acl_debian.stdout | default("")) == "CHANGED"
          failed_when: false
          when:
            - snmpd_conf_exists | bool
            - (os_family | default("UNKNOWN")) == "DEBIAN"
            - (weak_acl_found | default("NO")) == "YES"
            - (fix_allowed | default("NO")) == "YES"
    
        - name: "U-61 | remediate ACL (REDHAT)"
          ansible.builtin.shell: |
            set -o pipefail
            CONF="{{ SNMPD_CONF }}"
            SRC="{{ ALLOW_SNMP_SOURCE | trim }}"
            # com2sec <NAME> <SOURCE> <COMMUNITY>
            tmp="$(mktemp)"
            awk -v SRC="$SRC" '
              BEGIN{OFS=" "}
              /^[[:space:]]*#/ {print; next}
              /^[[:space:]]*com2sec[[:space:]]+/ {
                # 최소 4필드 가정
                if (NF>=4) {
                  if ($3=="default" || $3=="0.0.0.0" || $3=="0.0.0.0/0") {$3=SRC}
                }
                print; next
              }
              {print}
            ' "$CONF" > "$tmp"
            if ! cmp -s "$CONF" "$tmp"; then
              cp -p "$CONF" "$CONF.bak.U61.$(date +%Y%m%d%H%M%S)"
              cat "$tmp" > "$CONF"
              echo "CHANGED"
            else
              echo "NOCHANGE"
            fi
            rm -f "$tmp"
          args:
            executable: /bin/bash
          register: r_fix_acl_redhat
          changed_when: (r_fix_acl_redhat.stdout | default("")) == "CHANGED"
          failed_when: false
          when:
            - snmpd_conf_exists | bool
            - (os_family | default("UNKNOWN")) == "REDHAT"
            - (weak_acl_found | default("NO")) == "YES"
            - (fix_allowed | default("NO")) == "YES"
    
        - name: "U-61 | pick remediation result (changed?)"
          ansible.builtin.set_fact:
            r_fix_acl: >-
              {{
                (
                  (os_family == "DEBIAN")
                  | ternary(r_fix_acl_debian, r_fix_acl_redhat)
                )
              }}
          changed_when: false
          when:
            - (weak_acl_found | default("NO")) == "YES"
            - (fix_allowed | default("NO")) == "YES"
            - snmpd_conf_exists | bool
            - os_family in ["DEBIAN","REDHAT"]
    
        - name: "U-61 | restart snmpd (when changed)"
          ansible.builtin.systemd:
            name: "{{ SNMPD_SERVICE }}"
            state: restarted
          register: r_restart
          failed_when: false
          when:
            - (r_fix_acl.changed | default(false)) | bool
    
        - name: "U-61 | LOG step (remediation) JSONL"
          block:
            - name: "ts"
              ansible.builtin.command: "{{ LOG_TS_CMD }}"
              register: ts_611_c
              changed_when: false
    
            - name: "LOG step"
              ansible.builtin.debug:
                msg: >-
                  {{
                    {
                      "ts": (ts_611_c.stdout | default("")),
                      "flag_id": FLAG_ID,
                      "section": LOG_SECTION_STEP,
                      "title": "[U_61_1] SNMP 접근제어(Source) 교정 적용",
                      "cmd": (
                        (os_family == "DEBIAN")
                        | ternary(
                            "snmpd.conf: rocommunity/rwcommunity source append/replace -> " ~ (ALLOW_SNMP_SOURCE | trim),
                            "snmpd.conf: com2sec source replace(default/0.0.0.0) -> " ~ (ALLOW_SNMP_SOURCE | trim)
                          )
                      ) ~ " ; systemd restart snmpd when changed",
                      "result": "changed=" ~ (((r_fix_acl.changed|default(false))|bool)|string)
                                ~ ", restart_failed=" ~ (((r_restart.failed|default(false))|bool)|string)
                                ~ ", restart_msg=" ~ ((r_restart.msg | default("") | string) | truncate(160, True, "..."))
                    } | to_json
                  }}
              changed_when: false
          when:
            - (weak_acl_found | default("NO")) == "YES"
            - (fix_allowed | default("NO")) == "YES"
            - snmpd_conf_exists | bool
            - os_family in ["DEBIAN","REDHAT"]
    
        # =========================================================
        # basis 로그(케이스별)
        # =========================================================
        - name: "U-61 | LOG basis (auto applied) JSONL"
          block:
            - name: "ts"
              ansible.builtin.command: "{{ LOG_TS_CMD }}"
              register: ts_611_d
              changed_when: false
    
            - name: "LOG basis"
              ansible.builtin.debug:
                msg: >-
                  {{
                    {
                      "ts": (ts_611_d.stdout | default("")),
                      "flag_id": FLAG_ID,
                      "section": LOG_SECTION_BASIS,
                      "title": LOG_TITLE_BASIS,
                      "basis": (
                        "[U_61_1] 전체 허용(default/0.0.0.0/0 등)로 판단된 SNMP 접근제어(Source)를 허용 대역/호스트("
                        ~ (ALLOW_SNMP_SOURCE | trim)
                        ~ ")로 교정 적용(설정 변경 시 snmpd 재시작 시도)"
                      ),
                      "status": (((r_fix_acl.changed|default(false))|bool) | ternary("취약","양호"))
                    } | to_json
                  }}
              changed_when: false
          when:
            - (weak_acl_found | default("NO")) == "YES"
            - (fix_allowed | default("NO")) == "YES"
            - snmpd_conf_exists | bool
            - os_family in ["DEBIAN","REDHAT"]
    
        - name: "U-61 | LOG basis (weak but no allow source → info) JSONL"
          block:
            - name: "ts"
              ansible.builtin.command: "{{ LOG_TS_CMD }}"
              register: ts_611_info1
              changed_when: false
    
            - name: "LOG basis"
              ansible.builtin.debug:
                msg: >-
                  {{
                    {
                      "ts": (ts_611_info1.stdout | default("")),
                      "flag_id": FLAG_ID,
                      "section": LOG_SECTION_BASIS,
                      "title": LOG_TITLE_BASIS,
                      "basis": "[U_61_1] SNMP 접근제어가 전체 허용(default/0.0.0.0/0 등)으로 탐지되었으나, 허용 대역/호스트(ALLOW_SNMP_SOURCE)가 미지정/부적합하여 자동조치 금지(info) — 담당자가 운영망(모니터링 서버/관리자) 기준으로 허용 대역을 확정 후 snmpd.conf에 반영 필요",
                      "status": "info"
                    } | to_json
                  }}
              changed_when: false
          when:
            - (weak_acl_found | default("NO")) == "YES"
            - (fix_allowed | default("NO")) != "YES"
    
        - name: "U-61 | LOG basis (conf missing while used → info) JSONL"
          block:
            - name: "ts"
              ansible.builtin.command: "{{ LOG_TS_CMD }}"
              register: ts_611_info2
              changed_when: false
    
            - name: "LOG basis"
              ansible.builtin.debug:
                msg: >-
                  {{
                    {
                      "ts": (ts_611_info2.stdout | default("")),
                      "flag_id": FLAG_ID,
                      "section": LOG_SECTION_BASIS,
                      "title": LOG_TITLE_BASIS,
                      "basis": "[U_61_1] SNMP 서비스/프로세스가 사용 중인데 " ~ SNMPD_CONF ~ " 미존재: 설정 파일 비표준 경로/관리 부재 가능 — 접근제어 정책 점검/조치 타겟 특정 불가(info) — 담당자 확인 필요",
                      "status": "info"
                    } | to_json
                  }}
              changed_when: false
          when:
            - (snmpd_conf_exists | bool) == false
            - ((snmpd_is_active | default("NO")) == "YES") or ((snmpd_proc_exists | default("NO")) == "YES")
    
        - name: "U-61 | LOG basis (not used → safe) JSONL"
          block:
            - name: "ts"
              ansible.builtin.command: "{{ LOG_TS_CMD }}"
              register: ts_611_safe0
              changed_when: false
    
            - name: "LOG basis"
              ansible.builtin.debug:
                msg: >-
                  {{
                    {
                      "ts": (ts_611_safe0.stdout | default("")),
                      "flag_id": FLAG_ID,
                      "section": LOG_SECTION_BASIS,
                      "title": LOG_TITLE_BASIS,
                      "basis": "[U_61_1] SNMP 서비스 미사용(비활성/프로세스 미탐지)로 판단: 접근제어 조치 불필요(양호) — 필요 시 U-58 기준으로 snmpd 중지/비활성화 유지",
                      "status": "양호"
                    } | to_json
                  }}
              changed_when: false
          when:
            - (snmpd_is_active | default("NO")) != "YES"
            - (snmpd_proc_exists | default("NO")) != "YES"
    
        - name: "U-61 | LOG basis (already restricted → safe) JSONL"
          block:
            - name: "ts"
              ansible.builtin.command: "{{ LOG_TS_CMD }}"
              register: ts_611_safe1
              changed_when: false
    
            - name: "LOG basis"
              ansible.builtin.debug:
                msg: >-
                  {{
                    {
                      "ts": (ts_611_safe1.stdout | default("")),
                      "flag_id": FLAG_ID,
                      "section": LOG_SECTION_BASIS,
                      "title": LOG_TITLE_BASIS,
                      "basis": "[U_61_1] SNMP 접근제어(Source)에서 전체 허용(default/0.0.0.0/0 등) 설정 미탐지: 특정 호스트/대역 제한 기준을 충족(양호)",
                      "status": "양호"
                    } | to_json
                  }}
              changed_when: false
          when:
            - (snmpd_is_active | default("NO")) == "YES" or (snmpd_proc_exists | default("NO")) == "YES"
            - (snmpd_conf_exists | bool)
            - (weak_acl_found | default("NO")) != "YES"
    
        - name: "U-61 | LOG basis (os unknown → info) JSONL"
          block:
            - name: "ts"
              ansible.builtin.command: "{{ LOG_TS_CMD }}"
              register: ts_611_info3
              changed_when: false
    
            - name: "LOG basis"
              ansible.builtin.debug:
                msg: >-
                  {{
                    {
                      "ts": (ts_611_info3.stdout | default("")),
                      "flag_id": FLAG_ID,
                      "section": LOG_SECTION_BASIS,
                      "title": LOG_TITLE_BASIS,
                      "basis": "[U_61_1] OS 계열 판별 불가(UNKNOWN): snmpd.conf 구문(REDHAT com2sec / DEBIAN rocommunity/rwcommunity) 자동판단 신뢰 불가로 자동조치 불가(info) — 담당자 확인 필요",
                      "status": "info"
                    } | to_json
                  }}
              changed_when: false
          when: os_family == "UNKNOWN"
    
        # ---------------------------------------------------------
        # (블록 말미) summary 로그
        # ---------------------------------------------------------
        - name: "U-61 | [U_61_1] summary LOG(JSONL)"
          block:
            - name: "ts"
              ansible.builtin.command: "{{ LOG_TS_CMD }}"
              register: ts_611_s
              changed_when: false
    
            - name: "LOG step"
              ansible.builtin.debug:
                msg: >-
                  {{
                    {
                      "ts": (ts_611_s.stdout | default("")),
                      "flag_id": FLAG_ID,
                      "section": LOG_SECTION_STEP,
                      "title": "[U_61_1] summary",
                      "cmd": "detect OS/service/conf + detect weak ACL + optional fix with ALLOW_SNMP_SOURCE",
                      "result": "os=" ~ (os_family | default("UNKNOWN"))
                                ~ ", conf_exists=" ~ (((snmpd_conf_exists | default(false))|bool)|string)
                                ~ ", weak_acl_found=" ~ (weak_acl_found | default("NO"))
                                ~ ", fix_allowed=" ~ (fix_allowed | default("NO"))
                                ~ ", changed=" ~ ((((r_fix_acl.changed|default(false))|bool)|string))
                                ~ ", restart_failed=" ~ ((((r_restart.failed|default(false))|bool)|string))
                    } | to_json
                  }}
              changed_when: false