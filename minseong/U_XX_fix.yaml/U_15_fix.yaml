---
- name: 주요정보통신기반시설 보안 조치 - U-15 (소유자가 존재하지 않는 파일 및 디렉터리 존재 여부 점검)
  hosts: all
  become: yes

  vars:
  # 예시를 위해 DB에서 받은 데이터를 가정 (실제로는 postgres_query 등으로 받음)
  # db_result.query_result[0].val 값이 '123'(숫자형 문자열)인지 'abc'(문자열)인지에 따라 분기

    target_owner: "root"
    target_group: "root"
  tasks: 
   - name: "소유자나 그룹이 존재하지 않는 파일 및 디렉터리 확인"
      # 가이드의 find 명령어를 사용하여 소유자(-nouser) 또는 그룹(-nogroup)이 없는 대상 검색
     ansible.builtin.shell: |
      find / \( -nouser -o -nogroup \) -xdev -ls 2>/dev/null
     register: orphan_files
     failed_when: false
     changed_when: false

   - name: " 소유자가 존재하지 않는 파일 또는 디렉터리 제거"
     file:
      path: "{{item}}"
      state: absent
      owner: "{{ target_owner }}"
      group: "{{ target_group }}"
     loop: "{{ orphan_files.stdout_lines }}"
     

   - name: " 사용중이라 제거되지 않은 발견된 파일의 소유권 변경"
      # 이미지의 '조치 방법'에 따라 소유자 및 그룹을 변경함
      # (실제 환경에 따라 제거(rm)가 필요할 경우 file 모듈의 state: absent 사용)
     file:
      path: "{{ item.split()[-1] }}"
      owner: "{{ target_owner }}"
      group: "{{ target_group }}"
     loop: "{{ orphan_files.stdout_lines }}"
     

   
     