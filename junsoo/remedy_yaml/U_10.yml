---
- name: "U-10 | Check for Duplicate UIDs (Audit Only)"
  hosts: all
  become: yes
  gather_facts: no

  vars:
    FLAG_ID: "U-10"

    # 로그 관련 변수
    LOG_SECTION_STEP: "[조치 내용]"
    LOG_SECTION_BASIS: "[조치 결과]"
    LOG_TITLE_BASIS: "조치 근거"
    LOG_TS_CMD: "date +%Y-%m-%dT%H:%M:%S%z"

  tasks:
    # ---------------------------------------------------------
    # (공통) 변수 초기화
    # ---------------------------------------------------------
    - name: "U-10 | init defaults"
      ansible.builtin.set_fact:
        duplicate_details: []
      changed_when: false

    # =========================================================
    # 1. 진단: 중복 UID 식별 (Shell Script 로직)
    # =========================================================
    - name: "U-10 | Identify Duplicate UIDs"
      ansible.builtin.shell: |
        # 1. 중복된 UID 추출
        dupes=$(cut -d: -f3 /etc/passwd | sort | uniq -d)
        
        # 2. 각 중복 UID에 대해 계정명 매핑
        if [ -n "$dupes" ]; then
            for uid in $dupes; do
                accounts=$(awk -F: -v u="$uid" '$3 == u {printf "%s ", $1}' /etc/passwd)
                echo "UID:$uid Accounts:[$accounts]"
            done
        fi
      register: r_check_dupes
      changed_when: false
      failed_when: false

    - name: "U-10 | Parse results"
      ansible.builtin.set_fact:
        duplicate_details: "{{ r_check_dupes.stdout_lines | default([]) }}"
      changed_when: false

    # =========================================================
    # 2. 결과 로깅 (Audit Only)
    # =========================================================
    - name: "U-10 | 조치 내용 상세 LOG"
      block:
        - name: "ts"
          ansible.builtin.command: "{{ LOG_TS_CMD }}"
          register: ts_step
          changed_when: false

        - name: "LOG step"
          ansible.builtin.debug:
            msg: >-
              {{
                {
                  "ts": (ts_step.stdout | default("")),
                  "flag_id": FLAG_ID,
                  "section": LOG_SECTION_STEP,
                  "title": "중복 UID 계정 점검 (수동 조치 필요)",
                  "cmd": "Check /etc/passwd for duplicate UIDs",
                  "result": "duplicates_found=" ~ (duplicate_details | length > 0 | bool | string) ~
                            ", details=" ~ (duplicate_details | join(", ") if (duplicate_details | length > 0) else "None")
                } | to_json
              }}
          changed_when: false

    - name: "U-10 | 최종 결과 근거 LOG"
      block:
        - name: "ts"
          ansible.builtin.command: "{{ LOG_TS_CMD }}"
          register: ts_basis
          changed_when: false

        - name: "LOG basis"
          ansible.builtin.debug:
            msg: >-
              {{
                {
                  "ts": (ts_basis.stdout | default("")),
                  "flag_id": FLAG_ID,
                  "section": LOG_SECTION_BASIS,
                  "title": LOG_TITLE_BASIS,
                  "basis": (
                    (duplicate_details | length > 0) | ternary(
                      "중복 UID 발견: " ~ (duplicate_details | join(", ")) ~ " (수동 변경 및 파일 소유권 정리 필요)",
                      "중복된 UID를 사용하는 계정이 없음"
                    )
                  ),
                  "status": ((duplicate_details | length > 0) | ternary("취약(수동조치필요)", "양호"))
                } | to_json
              }}
          changed_when: false